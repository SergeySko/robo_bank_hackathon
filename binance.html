{% extends "layout.html" %}
{% block title %}Axy - Index{% endblock %}
{% block body %}


    <pre id="assetPre">{{debug}}</pre>    

    <script>
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://eth-enf644.c9users.io:8082"));
        }
        web3.eth.defaultAccount = web3.eth.accounts[0];
        var sbercoinContract = web3.eth.contract(
            [{"constant":false,"inputs":[{"name":"x","type":"address"}],"name":"address2str","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"endCreditDate","type":"uint256"},{"name":"sumCredit","type":"uint256"}],"name":"allocationCreditSumTest","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"time","type":"uint256"}],"name":"checkCredits","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"endTime","type":"uint256"}],"name":"checksCredits","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"earlyRepayment","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"symbol","type":"string"}],"name":"GetAssetInfo","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"duration","type":"uint256"},{"name":"amount","type":"uint256"}],"name":"getCredit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_period","type":"uint256"},{"name":"_value","type":"uint256"}],"name":"putDeposit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"day","type":"uint8"},{"name":"hour","type":"uint8"},{"name":"minute","type":"uint8"}],"name":"returnDeposits","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"sendMeCreditEvent","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"sendMeDepositEvent","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"info","type":"string"}],"name":"SetAssetInfo","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"percentDeposit","type":"uint8"},{"name":"percentCredit","type":"uint8"}],"name":"setSettings","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"clientAddress","type":"address"},{"name":"usedRating","type":"uint256"}],"name":"updateRatings","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"typeEvent","type":"uint8"},{"name":"timestamp","type":"uint256"}],"name":"watchDog","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"string"}],"name":"Test","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"string"},{"indexed":false,"name":"","type":"bool"},{"indexed":false,"name":"","type":"uint256"},{"indexed":false,"name":"","type":"uint256"}],"name":"TestData","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"typeEvent","type":"int256"},{"indexed":false,"name":"client","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"startDate","type":"uint256"},{"indexed":false,"name":"endDate","type":"uint256"}],"name":"DealEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"typeEvent","type":"int256"},{"indexed":false,"name":"client","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"endDate","type":"uint256"}],"name":"DealEndEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"symbol","type":"string"}],"name":"GetAssetInfoEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"t","type":"uint256"}],"name":"CreditHasTaken","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"string"},{"indexed":false,"name":"","type":"uint256"}],"name":"SuccessfulRepayment","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"constant":true,"inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getWhiteList","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"info","type":"string"}],"name":"PrintAssetInfo","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}]
        );
        var sbercoin = sbercoinContract.at("0xf7bd4ac1f13cf3bfa7876974be3a740bd3820303");     
        console.log(sbercoin);

        sbercoin.GetAssetInfoEvent().watch(function(error, result){
            if (!error) {
                let symbol = result.args.symbol;
                console.log(result.args);
                console.log("Event captured = " + symbol);
                
                $.ajax({
                    url: "/get_assets",
                    success: function(result) {
                        $("#assetPre").html(result);

                        let resultAssets = JSON.parse(result);
                        let asset = resultAssets.find(x => x.symbol == symbol);
                        if(asset) {
                            let info = asset.price;
                            console.log(symbol + " = " + info);
                            setAssetInfo(info);
                        }
                    }
                });                  
            } else {
                console.log(error);
            }
        });
        
        
        function setAssetInfo(info) {
            //sbercoin.SetAssetInfo(info).sendTransaction(
            //    {from:web3.eth.coinbase, gas:100000},
            //    function (error, result){ 
            //        if(!error)
            //            console.log(result);
            //        else
            //            console.error(error);
            //    }
            //)       
        
            sbercoin.SetAssetInfo(info, function(error, result){
                if(!error){
                    console.log(result);
                }
                else
                    console.error(error);
            });
        }
        
    </script>


{% endblock %}
